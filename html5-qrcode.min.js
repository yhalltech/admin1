// Simplified HTML5 QR Code Scanner Library
class Html5QrcodeScanner {
    constructor(elementId, config) {
        this.elementId = elementId;
        this.config = config || {};
        this.onScanSuccess = null;
        this.onScanError = null;
        this.scannerActive = false;
    }
    
    render(onScanSuccess, onScanError) {
        this.onScanSuccess = onScanSuccess;
        this.onScanError = onScanError;
        
        const container = document.getElementById(this.elementId);
        container.innerHTML = `
            <div class="qr-scanner-container">
                <video id="qr-video-${this.elementId}" width="400" height="300"></video>
                <div class="scanner-overlay"></div>
                <div class="scanner-line"></div>
                <div class="scanner-instructions">
                    <i class="bi bi-camera-video"></i> Point camera at QR code
                </div>
            </div>
        `;
        
        this.startScanning();
    }
    
    async startScanning() {
        try {
            const video = document.getElementById(`qr-video-${this.elementId}`);
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });
            video.srcObject = stream;
            video.play();
            this.scannerActive = true;
            
            // Simulate QR detection (in real app, use proper library)
            video.onloadedmetadata = () => {
                this.simulateQRDetection(video);
            };
        } catch (error) {
            console.error('Camera error:', error);
            if (this.onScanError) this.onScanError(error);
        }
    }
    
    simulateQRDetection(video) {
        // This is a simulation - in production use a proper QR library
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const checkQR = () => {
            if (!this.scannerActive) return;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Simulate QR detection (would be real QR parsing)
            const simulatedData = localStorage.getItem('simulated_qr_data');
            if (simulatedData && Math.random() > 0.7) {
                if (this.onScanSuccess) {
                    this.onScanSuccess(simulatedData);
                }
                this.stop();
            }
            
            requestAnimationFrame(checkQR);
        };
        
        checkQR();
    }
    
    stop() {
        this.scannerActive = false;
        const video = document.getElementById(`qr-video-${this.elementId}`);
        if (video && video.srcObject) {
            const stream = video.srcObject;
            stream.getTracks().forEach(track => track.stop());
        }
    }
    
    clear() {
        this.stop();
        document.getElementById(this.elementId).innerHTML = '';
    }
}